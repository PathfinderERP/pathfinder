name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # or master, depending on your default branch

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies & Build Frontend
        run: |
          cd frontend
          npm install
          npm run build
          # This creates a 'dist' or 'build' folder in frontend/

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          debug: true # Enable debugging to see why it fails
          script_stop: true # Stop script on first error
          script: |
            # Navigate to project directory
            export PROJECT_PATH="/home/ubuntu/pathfinder"
            
            # DEBUG: Check if directory exists
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "ERROR: Directory $PROJECT_PATH does not exist!"
              echo "Current directories in /home/ubuntu:"
              ls -la /home/ubuntu
              exit 1
            fi

            # 1. Pull latest code
            cd $PROJECT_PATH
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # 2. Update Backend
            cd backend
            npm install
            # Restart backend service
            pm2 restart backend || pm2 start server.js --name backend
            
            # 3. Update Frontend (build locally and upload? No, we are building on server here based on previous steps)
            # Wait, previous step built locally but didn't upload artifacts. 
            # This script pulls code and builds on server.
            cd ../frontend
            npm install
            npm run build
            
            # 4. Deploy Frontend to Nginx
            echo "Deploying frontend to /var/www/pathfinder-frontend..."
            # Ensure directory exists
            sudo mkdir -p /var/www/pathfinder-frontend
            sudo rm -rf /var/www/pathfinder-frontend/*
            sudo cp -r dist/* /var/www/pathfinder-frontend/
            
            echo "Deployment Complete"
